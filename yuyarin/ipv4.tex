% -*- coding: utf-8 -*-


\chapter{IPv4がこの先生きのこるには}
% * (アスタリスク)付きの \chapter* コマンドは原則不可とする

\begin{flushright}
 yuyarin % ペンネーム
\end{flushright}

\section{はじめに}

\lettrine{イ}
ンターネットの主要技術であるIPv4というプロトコル．その中で個体識別子として使われるIPv4アドレスは32bitで表現され数は約42億個である．
かつては「無限アドレスだぜヒャッハー」と湯水のように消費されていたのだが，70億もの人間が社会インフラとしてインターネットを必要としている
今となっては，このアドレスの数が全く足りなくなってしまっているのだ．
IPv4アドレスの新規割り当てはほぼ終了しており，IPv4アドレスは「枯渇」したと表現されている．

そこで出てくるのがIPv6である．もちろんIPv4の失敗を踏まえて色々な改良は施されているが，なんといっても128bitのアドレス空間が魅力である．
国内主要ISPのバックボーンは既にIPv6に対応できており，一部のISPでは利用可能になっているが，中小ISPなどではまだ利用できない．

RFC2460にてIPv6の仕様が発表されたのが1998年なので，既に14年が経っているのだが，未だに普及していないのだ．
IPv6に対応するためにはお金がかかるので，ISPもICP\footnote{Internet Content Provider}もお互いにIPv6対応しない限りメリットがなくデッドロックに陥っているのだ．

さすがにこのままではダメだということで，先の2012年6月6日にはWorld IPv6 Launchとして，
Googleを筆頭に世界中の主要サイトがIPv6を恒久的に有効にするという取り組みが行われた．

こうして徐々にデッドロックが解けてIPv6への対応が進んでいき，IPv4アドレスの枯渇がそれを更に加速させるだろう．
そしていずれIPv6が主要のプロトコルになりIPv4は古の技術として扱われるようになる未来が来るだろう．
だがしかし，すべての通信がIPv6に対応できるまで，我々はアドレスが枯渇しているIPv4を必死に「延命」させなければならないのだ．

前置きが長くなったが，この章ではそんな「IPv4延命技術」を紹介しようと思う．

\section{IPv4延命技術概観}

\lettrine{枯}
渇によってIPv4アドレスの割り振りを受けられなかったISPにおいて，顧客に割り当てるIPv4グローバルアドレスが
無くなってしまうというシナリオが，今後実際に起こるだろう．というか起きてる．
この時に必要になるのは\textbf{顧客間でIPv4グローバルアドレスを共有する}方法である．

IPv4アドレスの共有にはNAT\footnote{実際にはNAPTだが以降NATと呼ぶことにする}が使われる．

主要な技術をNATの場所とIPv4パケットのトランスポート方法で分類した表を表\ref{yuyarin-nat-transport}に示す．

\begin{table}[htbp]
\begin{center}
\begin{tabular}{cccc} \hline
 & IPv4ネイティブ & \multicolumn{2}{c}{IPv6トランスポート} \\
 & & カプセル化 & トランスレーション \\\hline
CPEでNAT & いまここ & MAP-E(旧4rd) & MAP-T \\
ISPでNAT & CGN & DS-Lite & 464XLAT \\\hline
\end{tabular}
\end{center}
\caption{NATの場所とトランスポート方法によるIPv4延命技術の分類}
\label{yuyarin-nat-transport}
\end{table}


\subsection{IPv4ネイティブ方式}

現在のIPv4ネットワークではCPE\footnote{Customer Premises Equipment}，いわゆるご家庭のルータでNATをしている．
これも1家庭1アドレス共有という１つのアドレス節約術であり，実は既にこの延命戦は始まっているのだ．
これに更にISP側でNATを重ねることで複数の家庭で１つのグローバルアドレスを共有するのがCGN(Carrier Grade NAT)である．

\subsection{IPv6トランスポート方式}
それに対してCPEにIPv6アドレスを割り当て，そのIPv6を利用してISP網内のIPv4バックボーンまでIPv4パケットを通す方法がある．
これはIPv6の使い方によってカプセル化とトランスレーションに分けられる．
カプセル化はいわゆるトンネルのことで，CPEとISPの間でIPv4 over IPv6トンネルを張り，IPv4パケットをIPv6パケットのデータとして運ぶ．
トランスレーションではIPv4パケットをIPv6区間を通る間だけIPv6パケットに変換する．

これらは更にNATをする場所によって分類できる．
CPEでNATして，プライベートアドレスからグローバルアドレスへ変換した後，IPv6でカプセル化するのがMAP-E(かつての4rd)，トランスレーションするのがMAP-Tである．
プライベートアドレスのIPv4パケットをIPv6でカプセル化してISP網内へ運んだ後，ISP側でNATしてグローバルアドレスへ変換するのがDS-Lite，
プライベートアドレスのIPv4パケットをIPv6パケットにトランスレーションして，ISP側でNATするのが464XLATである．
これらのIPv4グローバルアドレスは複数のCPEで同じ物が使われる．いくつのCPEで共有するかが設計のパラメータとなり，だいたい目安としては256程度である．

\section{ステート管理の問題}

\subsection{CGNのNATの問題}

NATの根底にある設計思想はアドレスだけでは識別子が足りないのでポート番号も識別子に使ってしまおうというものである．
NATでは(内部アドレス，内部送信元ポート，外部アドレス，外部送信元ポート)というバインディングをセッション情報として一定期間保持している．
そうしないと外から戻ってきたパケットを中の誰に送って良いのかわからなくなるからである．

CGNでは何千という家庭の通信をNATしなくてはならないので，NATのセッションデータベースは巨大なものになり生成頻度も高くなる．
ISPはユーザの通信を最低限90日間は保存しなくてはならないのだが，この時にNATのデータベースも併せて保存しておかないと
通信元の顧客が特定できなくなってしまう．

これらの処理はソフトウェアで行う必要があるためネットワーク機器からすれば意外と重い処理なのだ．
顧客数をnとすると定数項が大きい$\mathrm{O}(n)$の仕組みなのだがネットワーク業界ではこれはスケールすると言わなかったりする．

\subsection{IPv6トランスポート方式でのCPE特定の問題}

IPv6トランスポート方式ではISPからCPEへIPv4パケットを送ろうとした時に，
どのIPv6アドレスのCPEに対してパケットを送るのかを特定しなければならない．
NATに非常によく似た状況であるのだが，IPv6のアドレスの長さを生かした工夫がされている．

これらの技術ではStateless Address Mapping(SAM)という方式を採用している．
IPv4アドレスとポート番号が決まればIPv6アドレスが相互に一意に定まるような「ルール」を決める，
Stateless Address Mapping(SAM)という方式を採用している．
ルールさえ各機器で共有してしまえばCPEを特定するためのデータベース(ステート)の管理をする必要がないのだ．

この仕組みは顧客数nに対して定数オーダー$\mathrm{O}(1)$で処理できるために良くスケールする．

\section{ISP側NATにおける冗長化の問題}

ISPでは当然ネットワークの冗長性を確保しなくてはならない．２台の巨大NAT箱を置かなくてはならないのだ．
Act-Standby構成の場合，故障した時に即座にStandby機を起動して故障した機器からNATのセッションデータベースを受け取らなくてはならない．
故障しているのにそのようなことはできるはずがないので，当然ながらAct-Act構成になる．
IPネットワークでは往路と復路が必ずしも一致しない．NAT箱1を通って出ていったパケットの応答がNAT箱2に戻ってくることは，当たり前に起こりうることである．
よって2台のNAT箱は常にNATの巨大なセッションデータベースを同期し続け無くてはならないのだ．


