% -*- coding: utf-8 -*-


\chapter{IPv4がこの先生きのこるには}
% * (アスタリスク)付きの \chapter* コマンドは原則不可とする

\begin{flushright}
 yuyarin % ペンネーム
\end{flushright}

\section{はじめに}

\lettrine{イ}
ンターネットの主要技術であるIPv4というプロトコル．その中で個体識別子として使われるIPv4アドレスは32bitで表現され数は約42億個である．
かつては「無限アドレスだぜヒャッハー」と湯水のように消費されていたのだが，70億もの人間が社会インフラとしてインターネットを必要としている
今となっては，このアドレスの数が全く足りなくなってしまっているのだ．
IPv4アドレスの新規割り当てはほぼ終了しており，IPv4アドレスは「枯渇」したと表現されている．

そこで出てくるのがIPv6である．もちろんIPv4の失敗を踏まえて色々な改良は施されているが，なんといっても128bitのアドレス空間が魅力である．
国内主要ISPのバックボーンは既にIPv6に対応できており，一部のISPでは利用可能になっているが，中小ISPなどではまだ利用できない．

RFC2460にてIPv6の仕様が発表されたのが1998年なので，既に14年が経っているのだが，未だに普及していないのだ．
IPv6に対応するためにはお金がかかるので，ISPもICP\footnote{Internet Content Provider}もお互いにIPv6対応しない限りメリットがなくデッドロックに陥っているのだ．

さすがにこのままではダメだということで，先の2012年6月6日にはWorld IPv6 Launchとして，
Googleを筆頭に世界中の主要サイトがIPv6を恒久的に有効にするという取り組みが行われた．

こうして徐々にデッドロックが解けてIPv6への対応が進んでいき，IPv4アドレスの枯渇がそれを更に加速させるだろう．
そしていずれIPv6が主要のプロトコルになりIPv4は古の技術として扱われるようになる未来が来るだろう．
だがしかし，すべての通信がIPv6に対応できるまで，我々はアドレスが枯渇しているIPv4を必死に「延命」させなければならないのだ．

前置きが長くなったが，この章ではそんな「IPv4延命技術」を紹介しようと思う．

\section{IPv4延命技術概観}

\lettrine{枯}
渇によってIPv4アドレスの割当を受けられなかったISPにおいて，顧客に割り振るIPv4グローバルアドレスが無くなってしまうというシナリオが，今後実際に起こるだろう．
この時に必要になるのは\textbf{顧客間でIPv4グローバルアドレスを共有する}方法である．

主要な技術をNATの場所とIPv4パケットのトランスポート方法で分類した表を表\ref{yuyarin-nat-transport}に示す．

\begin{table}[htbp]
\begin{center}
\begin{tabular}{cccc} \hline
 & ネイティブ & カプセル化 & トランスレーション \\\hline
CPEでNAT & いまここ & MAP-E(旧4rd) & MAP-T \\
ISPでNAT & CGN & DS-Lite & 464XLAT \\\hline
\end{tabular}
\end{center}
\caption{NATの場所とトランスポート方法によるIPv4延命技術の分類}
\label{yuyarin-nat-transport}
\end{table}

IPv4アドレスの共有にはNAT\footnote{実際にはNAPTだが以降NATと呼ぶことにする}が使われる．

\subsection{IPv4ネイティブ方式}

現在のIPv4ネットワークではCPE\footnote{Customer Provider Edge}，いわゆるご家庭のルータでNATをしている．
これも1家庭1アドレス共有という１つのアドレス節約術であり，実は既にこの延命戦は始まっているのだ．
これに更にISP側でNATを重ねるのがCGN(Carrier Grade NAT)である．
これらはIPv4ネイティブで通信を行う．

\subsection{IPv6トランスポート方式}
その一方でIPv6バックボーンを利用してIPv4パケットを通すのが，カプセル化（いわゆるトンネル）とトランスレーションである．
カプセル化ではIPv4パケットをIPv6パケットのデータとして運ぶことで，
トランスレーションではIPv4パケットを一時的にIPv6パケットに変換することで，
IPv6バックボーン区間でIPv4の疎通性を確保する．

これらは更にNATをする場所によって分類できる．
CPEでNATしてプライベートアドレスからグローバルアドレスへ変換した後，IPv6でカプセル化するのがMAP-E(かつての4rd)，トランスレーションするのがMAP-Tである．
プライベートアドレスのIPv4パケットをIPv6でカプセル化して運んだ後，ISP側でNATしてグローバルアドレスへ変換するのがDS-Lite，
プライベートアドレスのIPv4パケットをIPv6パケットにトランスレーションして，ISP側でNATするのが464XLATである．

IPv6トランスポート方式では利用するIPv6アドレスをどのように決定・管理するのか，という問題がある．
これらの技術ではStateless Address Mapping(SAM)という方式を採用していて，
IPv4アドレスとポート番号が決まればIPv6アドレスが一意に定まるような「ルール」を決めて，各機器で共有する．
どのIPv4アドレスとどのIPv6アドレスが対応するのかというステートを持たないように工夫しているのだ．

\section{NATのセッション管理の問題}

NATを行うとセッションの管理が必然的に発生する．どの宛先のどのポートへの通信を誰が行ったかを記録して置かなければ，
返ってきたパケットを誰のところへ送り返せばよいのかわからなくなるからだ．

CPEでNATを行う場合，ゲートウェイが管理するセッションは１家庭の通信だけで，これは今の家庭用ルータの状況と変わらない．

一方でISP側でNATを行う場合，数千から数万家庭の通信をNATするため大量のセッションを管理しなくてはならない．
ISPでは当然ネットワークの冗長性を確保しなくてはならない．２台の巨大NAT箱を置かなくてはならないのだ．
Act-Standby構成の場合，故障した時に即座にStandby機を起動して故障した機器からNATのセッションデータベースを受け取らなくてはならない．
故障しているのにそのようなことはできるはずがないので，当然ながらAct-Act構成になる．
IPネットワークでは往路と復路が必ずしも一致しない．NAT箱1を通って出ていったパケットの応答がNAT箱2に戻ってくることは，当たり前に起こりうることである．
よって2台のNAT箱は常にNATの巨大なセッションデータベースを同期し続け無くてはならないのだ．


